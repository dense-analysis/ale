---
name: CI
on:  # yamllint disable-line rule:truthy
  push:
    branches: [ master ]  # yamllint disable-line rule:brackets
    tags:
      - v[0-9]+.[0-9]+.x
      - v[0-9]+.[0-9]+.[0-9]+
  pull_request:
    branches: [ master ]  # yamllint disable-line rule:brackets

jobs:
  build_image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build docker run image
        shell: bash
        env:
          DOCKER_HUB_USER: ${{ secrets.DOCKER_HUB_USER }}
          DOCKER_HUB_PASS: ${{ secrets.DOCKER_HUB_PASS }}
        run: ./run-tests --build-image
  test_ale:
    needs: build_image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        vim-version:
          - '--vim-80-only'
          - '--vim-82-only'
          - '--neovim-02-only'
          - '--neovim-06-only'
          - '--linters-only'
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./run-tests -v ${{ matrix.vim-version }}
  test_win:
    env:
      vim_version: 80-586
      vader_commit: 6fff477431ac3191c69a3a5e5f187925466e275a
    runs-on: windows-2019
    steps:
      ##### setup vim #####
      - name: Cache vim
        id: vim-cache
        uses: actions/cache@v3
        with:
          path: C:\vim
          key: ${{ runner.os }}-${{ env.vim_version }}
      - name: Download and unpack Vim
        if: steps.vim-cache.outputs.cache-hit != 'true'
        run: |
          Add-Type -A System.IO.Compression.FileSystem
          Invoke-WebRequest ftp://ftp.vim.org/pub/vim/pc/vim${{ env.vim_version }}w32.zip `
            -OutFile C:\vim.zip
          [IO.Compression.ZipFile]::ExtractToDirectory('C:\vim.zip', 'C:\vim')
          Invoke-WebRequest ftp://ftp.vim.org/pub/vim/pc/vim${{ env.vim_version }}rt.zip `
            -OutFile C:\rt.zip
          [IO.Compression.ZipFile]::ExtractToDirectory('C:\rt.zip', 'C:\vim')
        shell: powershell

      ##### setup vader #####
      - name: Cache vader
        id: vader-cache
        uses: actions/cache@v3
        with:
          path: C:\vader
          key: ${{ runner.os }}-${{ env.vader_commit }} 
      - name: Clone Vader and check out the commit we want
        uses: actions/checkout@v2
        if: steps.vader-cache.outputs.cache-hit != 'true'
        with:
          repository: 'junegunn/vader.vim'
          ref: ${{ env.vader_commit }}
          path: 'vader'
      - name: copy vader to required location
        if: steps.vader-cache.outputs.cache-hit != 'true'
        run: |
          if (-Not (Test-Path C:\vader))
          {
            md -path C:\vader
          }
          Copy-Item -Path ${env:GITHUB_WORKSPACE}\vader\* -Destination `
            C:\vader -recurse -Force
        shell: powershell

      ##### finally test the plugin #####
      - uses: actions/checkout@v2
        with:
          path: 'testplugin'
      - name: copy test plugin to required location
        run: |
          if (-Not (Test-Path C:\testplugin))
          {
            md -path C:\testplugin
          }
          Copy-Item -Path ${env:GITHUB_WORKSPACE}\testplugin\* -Destination `
            C:\testplugin -recurse -Force
        shell: powershell
      - name: Run tests
        run: |
          C:\vim\vim\vim80\vim.exe -u test\vimrc "+Vader! test/*.vader test/*/*.vader test/*/*/*.vader test/*/*/*.vader"
        shell: cmd 
        timeout-minutes: 5
